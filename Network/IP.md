# IP(Internet Protocol)
## 1 IP의 개요
### 1.1 IP의 특징과 역할
IP는 비연결/비신뢰(Best-effort) 방식으로 패킷을 목적지까지 라우팅해주는 프로토콜이다.  
주소 지정과 라우팅을 담당한다.
- **주소 지정(논리 주소)**
  
    IP는 각 호스트(디바이스)에 **고유한 논리 주소(IP 주소)** 를 부여하여 통신 상대를 식별한다.  
    MAC 주소가 하드웨어 수준의 식별자라면, IP 주소는 **네트워크 상의 위치(논리적 주소)** 를 나타낸다.  
    → 라우터는 이 IP 주소를 기반으로 목적지까지의 경로를 결정한다.  
    - **논리 주소의 의미**
        
        논리 주소는 각 장치마다 고정된 값이 아니라 네트워크에 연결 시에 해당 장치를 식별하기 위해 **부여되는 값**이다.  
        이 주소를 통해 네트워크 상에서 라우팅을 통해 상대에게 데이터를 전송한다.  
    - **IP 주소의 중복 가능성**
        
        IP 주소는 **같은 네트워크(서브넷) 내에서 유일해야** 한다.  
        (다른 네트워크에서는 같아도 상관없다.)  
        또한 **Anycast**처럼 하나의 공통 IP를 여러 서버가 사용하는 기술도 존재하지만, 이 경우에도 각 서버는 서로 다른 네트워크(서브넷)에 위치하며, **상위 라우터가 공통 IP를 각 리전의 IP에 매핑**하여 동작한다.
      
        → Anycast 환경에서도 **각 네트워크 내에서는 IP가 유일**하다.
- **비연결성(Connectionless)**
  
    IP는 연결을 확립하지 않고 데이터를 전송한다.  
    → 패킷을 바로 전송  
    → 각 패킷을 **독립적으로 라우팅**되고, 중간 경로가 달라질 수도 있다.  
    → 순서 보장이나 재전송을 하지 않는다. (TCP의 역할)
- **비신뢰성(Best-effort)**
  
    Best-effort 방식으로 IP는 패킷을 최선의 경로로 전달하는 역할만 한다.  
    → 순서 보장이나 재전송을 하지 않는다. (TCP의 역할)  
    (헤더 checksum을 진행하긴 하지만 재전송은 하지 않고, 이 또한 IPv6에서 제거됨)
- **패킷 단위 전송**
  
    IP는 데이터를 패킷(Packet) 단위로 나눠서 전송한다.  
    각 패킷은 독립적으로 라우팅되고, TCP/UDP 데이터에 IP 헤더가 붙은 구조를 가진다.  
    (패킷 크기가 MTU보다 클 경우 Fragmentation이 일어나서 여러 패킷으로 분할된다.)
- **상위 계층(TCP/UDP)과의 관계**
  
    IP는 OSI 3계층의 네트워크 계층에 해당하고, TCP/IP 모델에서 인터넷 계층에 해당한다.  
    TCP/UDP는 포트 기반으로 어떤 애플리케이션에 보낼지 결정하고, IP는 어떤 디바이스로 보낼지를 결정한다.
### 1.2 IPv4/IPv6 구조 및 차이점
- **IPv4 헤더**
  
    가변 20~60바이트이다.  
    IPv6에 없는 Header Checksum이 존재한다.  
    TTL(Time To Live), 중간 라우터 단편화를 지원한다.
- **IPv6 헤더**
  
    고정 40바이트이다.  
    IPv4의 Header Checksum이 제거되었다.  
    IPv4의 TTL과 동일한 Hop Limit 필드가 있다.(이름이 명확해짐)
- **IPv6의 주소 개선점**
  
    - **주소 크기**  
        IPv4는 32비트로 개수가 부족했지만, IPv6는 128비트로 사실상 고갈될 일이 없다.
    - **주소 표기**  
        IPv4는 10진수로 4개의 필드를 점(`.`)으로 구분했고,  
        IPv6는 16진수로 8개의 필드를 콜론(`:`)으로 구분한다.
    - **브로드캐스트 제거**  
        IPv6에서는 브로드캐스트가 제거되었다.  
        IPv4에서는 CIDR 비트를 전부 1로 채우면 해당 네트워크에서 브로드캐스트 주소가 됐다.  
        → IPv6에서는 이 브로드캐스트 주소 자체가 정의되어 있지 않다.  
        (IPv6에서는 멀티캐스트로 그룹 단위로 데이터를 전송할 수 있다.)
    - **헤더 구조**  
        가변적이었던 IPv4와 달리 IPv6의 헤더는 40바이트로 고정이고, Header Checksum이 제거되었다.
    - **주소 할당**  
        IPv4는 수동 설정이나 DHCP 등을 통한 IP를 할당받아야 하지만, IPv6는 자체 주소 설정이 가능하다.  
        SLAAC라는 메커니즘을 통해 라우터가 멀티캐스트로 전송하는 메시지와 호스트 자체 값을 결합해 IP 주소를 구성한다.
## 2 IP 주소 체계
### 2.1 공인IP / 사설IP
- **공인 IP**
  
    전 세계 인터넷에서 고유하며 라우팅되는 주소이다. ISP가 할당한다.
- **사설 IP**
  
    내부 네트워크 전용 주소이다.  
    인터넷 백본에서 라우팅되지 않고, 라우터의 NAT를 통해 외부와 통신한다.  
    → 글로벌 라우팅 테이블에 등록되지 않는다.
### 2.2 서브넷마스크 / CIDR
- **IP 주소의 클래스 개념**
  
    IP 주소(IPv4)는 32비트(4바이트)로 이루어져 있다.

    | 클래스   | 주소 범위                       | 시작 주소     | 기본 서브넷마스크               | 네트워크 비트 | 호스트 비트 | 사용 가능한 호스트 수 | 용도                  |
    | ----- | --------------------------- | --------- | ----------------------- | ------- | ------ | ------------ | ------------------- |
    | **A** | 0.0.0.0 ~ 127.255.255.255   | 1.0.0.0   | **255.0.0.0 (/8)**      | 8       | 24     | 16,777,214   | 대형 네트워크 (국가/대기업)    |
    | **B** | 128.0.0.0 ~ 191.255.255.255 | 128.0.0.0 | **255.255.0.0 (/16)**   | 16      | 16     | 65,534       | 중형 네트워크 (학교/기관)     |
    | **C** | 192.0.0.0 ~ 223.255.255.255 | 192.0.0.0 | **255.255.255.0 (/24)** | 24      | 8      | 254          | 소형 네트워크 (소규모 기업/가정) |
    | **D** | 224.0.0.0 ~ 239.255.255.255 | 224.0.0.0 | 사용 안 함                  | -       | -      | -            | **멀티캐스트용**          |
    | **E** | 240.0.0.0 ~ 255.255.255.255 | 240.0.0.0 | 사용 안 함                  | -       | -      | -            | **실험용(예약됨)**        |
- **서브넷 마스크**
  
    IP를 **네트워크 부분과 호스트 부분으로 나누는** 비트 마스크이다.  
    ex) `255.255.255.0` → 앞 24비트가 네트워크, 뒤 8비트가 호스트  
    → 사용 가능(호스트): 총 254개
- **CIDR(Classless Inter-Domain Routing)**
  
    "클래스 없는 도메인 간 라우팅"  
    이전에는 클래스 기반으로 A/B/C로 네트워크 영역과 호스트 영역의 크기를 고정으로 나눴다.  
    → 300개의 서버가 필요하면 클래스 C(254개)는 적고, 클래스 B(65,534개)는 너무 많다.  
    → **주소 낭비가 심하다.**  

    CIDR은 클래스 개념을 버리고, 필요한 만큼 비트를 쓰는 **가변 길이 마스크(VLSM)** 방식을 도입했다.  
    → `IP주소 / 네트워크 부분 비트 수`  
    → `/20`은 12개의 호스트 비트로 4094개의 호스트가 가능하다.  
    - **프리픽스(prefix)**  
        CIDR 이후로 서브넷마스크 대신 `/24`와 같이 **프리픽스 길이(prefix length)** 로 네트워크 비트의 길이를 표기하는 것이 표준이 되었다.
### 2.3 브로드캐스트 / 네트워크 주소
- **네트워크 주소(Network Address)**
  
    해당 네트워크 전체를 대표하는 주소이다.  
    IP 주소에서 **호스트 부분 비트가 모두 0으로 설정**된 주소이다.  
    네트워크를 식별하는 용도이고, 실제 장치에는 할당할 수 없다.  
    - **존재 목적과 IPv6에서 사라진 이유**  
        IPv4는 처음 설계 당시 CIDR이 없었고 네트워크 비트를 구분하기 위해 네트워크 주소가 있어야 해당 네트워크를 나타내기 위한 식별자가 필요했다.  
        **IPv6부터는 프리픽스가 주소 표기에 포함되기 때문에 따로 네트워크를 지칭하는 주소가 필요 없어**졌고, 호스트 비트가 모두 0인 주소도 할당이 가능해졌다.
- **브로드캐스트 주소(Broadcast Address)**
  
    **네트워크 내 모든 호스트에게** 동시에 패킷을 전달하기 위한 주소이다.  
    IP 주소에서 **호스트 부분 비트가 모두 1로 설정**된 주소이다.  
    네트워크 주소와 마찬가지로 실제 장치에는 할당할 수 없다.  
    IPv4에서만 존재하고, IPv6에서는 멀티캐스트로 대체되었다.  
    → **IPv6에서는 호스트 부분 비트가 모두 1인 주소도 정상적으로 사용 가능**하다.

| 구분            | 비트 패턴      | 역할              | 사용 가능 여부 |
| ------------- | ---------- | --------------- | -------- |
| **네트워크 주소**   | 호스트 비트 = 0 | 네트워크 식별         | 불가능        |
| **브로드캐스트 주소** | 호스트 비트 = 1 | 네트워크 내 모든 장치 대상 | 불가능        |

## 3 주소 관리 및 변환
### 3.1 DHCP(Dynamic Host Configuration Protocol)
IP 주소를 자동으로 할당해주는 프로토콜이다.  

모든 장치의 네트워크 설정을 수동으로 하면 귀찮고 충돌 위험이 있다.  
→ DHCP를 통해 클라이언트가 네트워크에 연결될 때 자동으로 IP, 서브넷마스크, 게이트웨이, DNS 등을 할당받는다.  

DHCP 응용 계층 프로토콜이고, 전송 계층 프로토콜로는 UDP를 사용한다.
- **동작 과정**
  
    클라이언트는 DHCP 서버가 있는지 브로드캐스트로 확인한다.  
    DHCP 서버가 있으면 사용 가능한 IP 주소와 설정 정보를 제안해준다.  
    클라이언트가 서버에게 특정 IP 주소를 쓰겠다고 요청한다.  
    서버가 승인한다.
### 3.2 NAT(Network Address Translation)
내부 사설(private) IP를 외부 공인(public) IP로 바꿔주는 기술이다.  
(사설망 ↔ 인터넷 간 주소 체계 변환)
- **NAT의 필요 이유**
  
    IPv4의 주소 부족, 보안성, 관리 편의
- **NAT의 종류**
  
    **Static NAT**  
    → 하나의 내부 IP와 하나의 공인 IP를 고정 매핑  

    **Dynamic NAT**  
    → 내부 IP가 NAT 풀(Pool)의 공인 IP 중 하나를 임시로 사용  

    **PAT(Port Address Translation)**  
    → 여러 내부 IP가 하나의 공인 IP를 포트로 구분해 공유  
    → 공인 IP 1개로 여러 사설 IP가 동시에 외부 통신을 할 수 있게 됨  
    → **IPv4의 IP 주소 부족 문제 해결**  
    일반적인 NAT는 사실상 PAT이다.
- **NAT의 한계**
  
    외부에서 내부로 직접 접근이 불가능하다.  
    P2P 통신이 어렵다. (이를 해결하기 위한 것이 포트 포워딩)
### 3.3 포트포워딩(Port Forwarding)
NAT 환경에서 외부에서 내부 서버로 접근할 수 있도록 특정 포트를 열어주는 설정이다.  
→ 공유기가 받은 **특정 포트로 들어오는 요청을, 내부의 특정 장치로 전달하는 기술**이다.   
- **NAT와 포트포워딩의 차이**
  
    NAT는 내부 망에서 외부 인터넷으로 가는 요청을 공인 IP 주소로 변환하는 기술이고, 그때 그때 동적으로 포트가 할당된다.(PAT)  

    포트포워딩은 외부에서 사설 네트워크의 호스트에 연결하기 위해 특정 포트로 들어오는 요청을 내부 특정 호스트로 고정 매핑하는 기술이다.  
    → 수동 설정으로 **NAT 테이블에 정정(static) 매핑을 미리 등록해두는 방식**이다.  

    NAT → 일반적으로 PAT를 말함.  
    포트포워딩 → static NAT를 말함.
## 4 보조 프로토콜
### 4.1 ARP(Address Resolution Protocol)
같은 네트워크(동일 서브넷) 내에서 IP 주소를 MAC 주소로 변환한다.  
데이터 링크 계층과 네트워크 계층 사이의 연결고리이다.(데이터 링크 계층의 프로토콜)  
→ 같은 서브넷(같은 브로드캐스트 도메인)에서만 동작한다.  
→ 목적지가 같은 서브넷에 있으면 목적지 호스트 IP에 대해 ARP 수행  
→ 목적지가 다른 서브넷에 있으면 게이트웨이(라우터)의 IP에 대해 ARP 수행
- **동작 과정**
  
    브로드캐스트로 IP 주소 전송  
    → 해당 IP를 가진 장치가 유니캐스트로 MAC 주소 응답  
    → 송신자는 이 정보를 ARP 캐시에 저장 (ARP Table)
### 4.2 ICMP(Internet Control Message Protocol)
IP 통신 중 오류를 보고하고 진단 메시지를 전송하는 프로토콜이다.  
→ IP 프로토콜 내부에서 보조 제어 프로토콜 역할(IP의 하위 보조 채널)  

**비신뢰적**으로, 데이터 전송용이 아니다.  
→ 단순히 "연결 상태와 문제"를 알려줌.
- **주요 기능**
  
    오류 보고 / 경로제어, 진단 / 혼잡,제한 알림 / 시간 초과
## 5 패킷 처리
### 5.1 IP Fragmentation / Reassembly
MTU(Maximum Transmission Unit)에 따라, 상위 계층의 데이터가 하위 계층이 한 번에 전송할 수 있는 데이터의 최대 크기보다 크면 이를 여러 조각으로 나눠서 전송한다.  
→ TCP/UDP 세그먼트를 캡슐화 한 IP 패킷의 크기가 출력 링크의 MTU보다 크면 이를 여러 Fragment로 나눈다.  
→ 하나의 TCP/UDP 데이터에 대해 여러 IP 패킷이 생길 수 있다.
- **문제점**
  
    라우터 부하 증가  
    패킷 손실 시 전체 재전송  
현대 네트워크는 라우터에서의 단편화를 최대한 피한다.  
→ 단편화는 호스트에서 수행
### 5.2 TTL(Time To Live)
IP 패킷이 라우터를 몇 번까지 거칠 수 있는지 제한하는 값이다.  
→ **단위는 시간이 아니라 홉(hop)이다.**  
→ 라우터를 지날 때마다 1씩 감소하고 0이 되면 패킷을 폐기한다.  
→ **무한 루프가 방지**된다.  

OS에서 IP 패킷의 헤더에 설정한다.  
헤더 필드 명이 IPv4와 IPv6에서 다르다.  
→ IPv4에서는 **TTL**이고, IPv6에서는 **Hop Limit**이다.

- **IP 패킷이 버려지는 경우?**  
    - 라우터 대기 큐가 꽉찬 경우(오버플로우)
    - 헤더 체크섬이 잘못된 경우(IPv4)
    - TTL이 0이 된 경우
